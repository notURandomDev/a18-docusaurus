name: Deploy Docusaurus to Tencent COS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install Dependencies and Build
        run: |
          npm config set registry https://registry.npmmirror.com
          npm ci
          npm run build
          ls -la build/
          if [ ! -f build/index.html ]; then
            echo "âŒ Error: build/index.html not found"
            exit 1
          fi

      - name: Deploy to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: a18-doc-1340028816
          COS_REGION: ap-shanghai
        run: |
          # å®‰è£… coscmd
          pip install coscmd -i https://mirrors.tencent.com/pypi/simple

          # æ£€æŸ¥å˜é‡æ˜¯å¦æ­£ç¡®ä¼ å…¥
          echo "ğŸ” Checking secrets..."
          echo "COS_SECRET_ID=${COS_SECRET_ID:0:4}***"
          echo "COS_SECRET_KEY=${COS_SECRET_KEY:0:4}***"
          echo "COS_BUCKET=$COS_BUCKET"
          echo "COS_REGION=$COS_REGION"

          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ] || [ -z "$COS_BUCKET" ] || [ -z "$COS_REGION" ]; then
            echo "âŒ Missing required environment variables"
            exit 1
          fi

          # é…ç½® coscmd
          echo "âš™ï¸ Configuring coscmd..."
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" -b "$COS_BUCKET" -r "$COS_REGION"

          # è®¾ç½®å¸¸è§ MIME ç±»å‹
          echo "ğŸ› ï¸ Setting MIME types..."
          coscmd config mime .html text/html
          coscmd config mime .css text/css
          coscmd config mime .js application/javascript
          coscmd config mime .json application/json
          coscmd config mime .ico image/x-icon
          coscmd config mime .svg image/svg+xml
          coscmd config mime .jpg image/jpeg
          coscmd config mime .jpeg image/jpeg
          coscmd config mime .png image/png
          coscmd config mime .txt text/plain
          coscmd config mime .xml application/xml

          # ä¸Šä¼ æ„å»ºæ–‡ä»¶å¤¹å†…å®¹
          echo "ğŸš€ Uploading files to COS..."
          coscmd upload -rs --delete -y ./build/ /

          # è¾“å‡ºä¸Šä¼ åçš„æ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“‚ Upload complete. Listing COS root:"
          coscmd list /

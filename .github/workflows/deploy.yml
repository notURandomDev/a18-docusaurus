name: Deploy Docusaurus to Tencent COS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install Dependencies and Build
        run: |
          npm config set registry https://registry.npmmirror.com
          npm ci
          npm run build
          ls -la build/
          if [ ! -f build/index.html ]; then
            echo "Error: build/index.html not found"
            exit 1
          fi

      - name: Deploy to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: a18-doc-1340028816
          COS_REGION: ap-shanghai
        run: |
          # 安装 coscmd
          pip install coscmd -i https://mirrors.tencent.com/pypi/simple

          # 检查密钥
          echo "COS_SECRET_ID is set to: ${COS_SECRET_ID:0:4}..."
          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ]; then
            echo "Error: COS_SECRET_ID or COS_SECRET_KEY is empty"
            exit 1
          fi

          # 配置 coscmd
          coscmd config -a $COS_SECRET_ID -s $COS_SECRET_KEY -b $COS_BUCKET -r $COS_REGION

          # 设置 MIME 类型
          coscmd config mime .html text/html
          coscmd config mime .css text/css
          coscmd config mime .js application/javascript
          coscmd config mime .json application/json
          coscmd config mime .ico image/x-icon
          coscmd config mime .svg image/svg+xml
          coscmd config mime .jpg image/jpeg
          coscmd config mime .jpeg image/jpeg
          coscmd config mime .png image/png
          coscmd config mime .txt text/plain
          coscmd config mime .xml application/xml

          # 上传文件
          coscmd upload -rs --delete -y ./build/ /

          # 查看上传结果
          coscmd list /

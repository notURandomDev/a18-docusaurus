name: Deploy Docusaurus to Tencent COS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm ci

      - name: Build Docusaurus
        run: |
          npm run build
          ls -la build/  # 调试：输出 build 目录
          ls -la build/img/  # 调试：输出 favicon 等静态资源
          if [ ! -f build/index.html ]; then
            echo "Error: build/index.html not found"
            exit 1
          fi
          if [ ! -f build/img/favicon.ico ]; then
            echo "Warning: build/img/favicon.ico not found"
          fi

      - name: Install coscmd
        run: |
          pip install coscmd -i https://mirrors.tencent.com/pypi/simple

      - name: Deploy to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: a18-doc-1340028816
          COS_REGION: ap-shanghai
        run: |
          echo "COS_SECRET_ID is set to: ${COS_SECRET_ID:0:4}..."  # 调试：部分显示密钥
          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ]; then
            echo "Error: COS_SECRET_ID or COS_SECRET_KEY is empty"
            exit 1
          fi
          coscmd config -a $COS_SECRET_ID -s $COS_SECRET_KEY -b $COS_BUCKET -r $COS_REGION
          coscmd upload -rs --delete -y --headers '{
            "*.html": {"Content-Type": "text/html", "Content-Disposition": "inline", "Cache-Control": "max-age=3600"},
            "*.css": {"Content-Type": "text/css", "Cache-Control": "max-age=31536000"},
            "*.js": {"Content-Type": "application/javascript", "Cache-Control": "max-age=31536000"},
            "*.png": {"Content-Type": "image/png", "Cache-Control": "max-age=31536000"},
            "*.jpg": {"Content-Type": "image/jpeg", "Cache-Control": "max-age=31536000"},
            "*.ico": {"Content-Type": "image/x-icon", "Cache-Control": "max-age=31536000"},
            "*.svg": {"Content-Type": "image/svg+xml", "Cache-Control": "max-age=31536000"}
          }' ./build/ /
          coscmd list /  # 调试：输出上传文件列表
          coscmd info /index.html  # 调试：输出 index.html 元数据
